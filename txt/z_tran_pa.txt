z_tran_pa1:--z_tran_pa1
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcno nvarchar(20)
declare @t_ecno nvarchar(20)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bproductno nvarchar(20)
declare @t_eproductno nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_bcno = case when '#non' = [6] then '' else [6] end
set @t_ecno = case when '#non' = [7] then CHAR(255) else [7] end
set @t_bcustno = case when '#non' = [8] then '' else [8] end
set @t_ecustno = case when '#non' = [9] then CHAR(255) else [9] end
set @t_bproductno = case when '#non' = [10] then '' else [10] end
set @t_eproductno = case when '#non' = [11] then CHAR(255) else [11] end

declare @tmp table(
	gno nvarchar(1),
	noa nvarchar(50),	
	datea nvarchar(10),
	custno nvarchar(50),
	comp nvarchar(100),
	sname nvarchar(50),
	stel nvarchar(50),
	saddr nvarchar(max),
	rname nvarchar(50),
	rtel nvarchar(50),
	raddr nvarchar(max),
	productno nvarchar(50),
	product nvarchar(50),
	mount float,
	memo nvarchar(max)
)
insert @tmp
select '0',noa,edate,custno,cust,conn,tel,address,lat,lat2,address2,productno,product,sum(mount),memo
from view_tranvcces
where (edate between @t_bdate and @t_edate)
and(cno between @t_bcno and @t_ecno)
and(custno between @t_bcustno and @t_ecustno)
and(productno between @t_bproductno and @t_eproductno)
group by noa,edate,custno,cust,conn,tel,address,lat,lat2,address2,productno,product,memo

select 
LEFT(datea,3)+'年'+SUBSTRING(datea,5,2)+'月'+RIGHT(datea,2)+'日' datea
,dbo.getComma(mount,0)mount
,* from @tmp
order by noa,custno
;
--------------------------------------------------------------------------------------------------
z_tran_pa2:--z_tran_pa2
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_bcno nvarchar(20)
declare @t_ecno nvarchar(20)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bdriverno nvarchar(20)
declare @t_edriverno nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end
set @t_bcno = case when '#non' = [6] then '' else [6] end
set @t_ecno = case when '#non' = [7] then CHAR(255) else [7] end
set @t_bcustno = case when '#non' = [8] then '' else [8] end
set @t_ecustno = case when '#non' = [9] then CHAR(255) else [9] end
set @t_bdriverno = case when '#non' = [14] then '' else [14] end
set @t_edriverno = case when '#non' = [15] then CHAR(255) else [15] end

declare @tmp table(
    gno nvarchar(1),
	datea1 nvarchar(10),
	datea2 nvarchar(10),
	trandate nvarchar(50),
	ttype nvarchar(50),
	custno nvarchar(50),
	comp nvarchar(50),
	noa nvarchar(50),
	noq nvarchar(50),
	trdno nvarchar(50),
	straddr nvarchar(50),
	driverno nvarchar(50),
	driver nvarchar(50),
	endaddr nvarchar(50),
	total float
)
insert @tmp
select '0',a.datea,b.datea,b.trandate+case when isnull(b.trandate,'')!='' then ' '+caseuseno else caseuseno end
,case b.ttype when 1 then '月結' end,a.addrno,a.addr,b.noa,b.noq,'',b.straddr,b.driverno,b.driver,b.endaddr,b.total
from view_trans b
left join view_tran a on a.noa=b.noa
where (b.trandate between @t_bdate and @t_edate)
and (a.addrno between @t_bcustno and @t_ecustno)
and (b.driverno between @t_bdriverno and @t_edriverno)
and b.total!=0

update @tmp
set trdno=b.noa
from @tmp a
outer apply(select noa from view_trds where a.noa=tranno and a.noq=trannoq)b

insert @tmp(gno,custno,comp,total)
select '1',custno,comp,SUM(total)
from @tmp
group by custno,comp

insert @tmp(gno,custno,total)
select '2',CHAR(255),SUM(total)
from @tmp
where gno='1'

select 
dbo.getComma(total,0)total
,* from @tmp
order by custno,gno,datea1,datea2
;
--------------------------------------------------------------------------------------------------
z_tran_pa3:--z_tran_pa3
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
set @t_bdate = case when '#non' = [2] then '' else [2] end
set @t_edate = case when '#non' = [3] then CHAR(255) else [3] end

declare @tmp table(
	rr int,
	crr int,
	datea nvarchar(10),
	carno nvarchar(50),
	spec nvarchar(50),
	mount float,
	oilmount float
)
insert @tmp
select ROW_NUMBER()over(partition by a.trandate order by a.carno),ROW_NUMBER()over(partition by a.carno,left(a.trandate,6) order by a.trandate)
,trandate,a.carno,c.spec,a.mount,d.mount
from view_trans a
left join car2 b on a.carno=b.noa
left join carspec c on c.noa=b.carspecno
left join oil d on a.trandate=d.oildate and a.carno=b.carno
where ISNULL(a.carno,'')!=''
and (c.spec='營業大貨車' or c.spec='營業小貨車')
and (a.trandate between @t_bdate and @t_edate)
group by trandate,a.carno,unit2,c.spec,a.mount,d.mount,a.unit

declare @result table(
	gno nvarchar(1),
	mon nvarchar(10),
	datea float,--營業天數
	carbc float,--大營業車輛
	carsc float,--小營業車輛
	tcarbc float,--大實動車輛
	tcarsc float,--小實動車輛
	bmount float,
	smount float,
	bmiles float,
	smiles float,
	bunit2 float,
	sunit2 float
)
insert @result(gno,mon,datea)
select '0',LEFT(datea,6),count(datea)
from @tmp
where rr=1
group by LEFT(datea,6)


update @result
set tcarbc=b.counta
from @result a
outer apply(select count(carno)counta from @tmp where crr=1 and spec='營業大貨車' and a.mon=LEFT(datea,6))b

update @result
set tcarsc=b.counta
from @result a
outer apply(select count(carno)counta from @tmp where crr=1 and spec='營業小貨車' and a.mon=LEFT(datea,6))b

update @result
set carbc=a.bc
from(select case when b.spec='營業大貨車' then count(a.noa) end bc 
from car2 a left join carspec b on a.carspecno=b.noa where b.spec='營業大貨車' group by b.spec) a

update @result
set carsc=a.bc
from(select case when b.spec='營業小貨車' then count(a.noa) end bc 
from car2 a left join carspec b on a.carspecno=b.noa where b.spec='營業小貨車' group by b.spec) a

update @result
set bmount=b.bmount/a.tcarbc,smount=b.smount/a.tcarsc,bmiles=b.boilmount,smiles=b.soilmount
from @result a
outer apply(select 
case when spec='營業大貨車' then SUM(isnull(mount,0)) end bmount
,case when spec='營業小貨車' then SUM(isnull(mount,0)) end smount
,case when spec='營業大貨車' then SUM(isnull(oilmount,0)) end boilmount
,case when spec='營業小貨車' then SUM(isnull(oilmount,0)) end soilmount
from @tmp where a.mon=LEFT(datea,6) group by LEFT(datea,6),spec)b

update @result
set bunit2=datea*2,sunit2=datea*2,bmiles=bmiles/tcarbc*4/datea*2,smiles=smiles/tcarsc*4/datea*2

select 
dbo.getComma(isnull(bmount,0),0)bmount
,dbo.getComma(isnull(smount,0),0)smount
,dbo.getComma(isnull(bmiles,0),1)bmiles
,dbo.getComma(isnull(smiles,0),1)smiles
,* from @result
order by mon,gno
;
---------------------------------------------------------------------------------------------
z_tran_pa4:--z_tran_pa4
declare @t_bcno nvarchar(20)
declare @t_ecno nvarchar(20)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
declare @t_bvdate nvarchar(20)
declare @t_evdate nvarchar(20)
declare @t_bvnoa nvarchar(20)
declare @t_evnoa nvarchar(20)
declare @t_stype nvarchar(20)
set @t_bcno = case when '#non' = [6] then '' else [6] end
set @t_ecno = case when '#non' = [7] then CHAR(255) else [7] end
set @t_bcustno = case when '#non' = [8] then '' else [8] end
set @t_ecustno = case when '#non' = [9] then CHAR(255) else [9] end
set @t_bvdate = case when '#non' = [16] then '' else [16] end
set @t_evdate = case when '#non' = [17] then CHAR(255) else [17] end
set @t_bvnoa = case when '#non' = [18] then '' else [19] end
set @t_evnoa = case when '#non' = [19] then CHAR(255) else [19] end
set @t_stype = case when '#non' = [20] then '' else [20] end

declare @tmp table(
	gno nvarchar(1),
	custno nvarchar(50),
	comp nvarchar(100),
	rr int,
	typea nvarchar(50),
	datea nvarchar(10),
	vno nvarchar(50),
	total float,
	memo nvarchar(max)
)
insert @tmp
select '0',a.custno,a.comp,'',isnull(a.stype,''),b.date1,isnull(a.so,''),SUM(isnull(b.total,0)),a.memo
from view_tranordes b left join view_tranorde a on a.noa=b.noa
where (a.cno between @t_bcno and @t_ecno)
and (a.custno between @t_bcustno and @t_ecustno)
and (a.so between @t_bvnoa and @t_evnoa)
and (b.date1 between @t_bvdate and @t_evdate)
and (len(@t_stype)=0 or a.stype=@t_stype)
group by a.custno,a.comp,isnull(a.stype,''),b.date1,isnull(a.so,''),a.memo

insert @tmp(custno,gno,total)
select custno,'1',SUM(total)
from @tmp
group by custno

insert @tmp(custno,gno)
select custno,'2'
from @tmp
group by custno

select * from @tmp
order by custno,gno
;
		